---
# title: "Relevamiento satelital de severidad del Incendio Complejo Lago Martin 2021-22"
#author: "Romina Gonzalez Musso"
# date: "8/4/2022"
always_allow_html: true
output:
  github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## **2. CÁLCULOS DE SUPERFICIES POR CATEGORÍA DE SEVERIDAD**

### **2a. Obtener el perímetro del incendio**

En esta sección de utilizará el **archivo raster dNBR** exportado con rgee. Se asume que luego de exportado, fue descargado a un directorio en la PC local. Por lo tanto debe ser importado a la sesión de R. Para la manipulación de datos espaciales se usará la librería `terra`

```{r, message=FALSE, warning=FALSE, include=TRUE, paged.print=FALSE, results = FALSE}
library(terra)

# Importar el raster 
nbr_wgs84 <- rast(paste0("_rasters/dNBR_scaled_masked.tif")) 

# Proyectar a un sistema de coordenadas planas
nbr_posgar1 <- terra::project(nbr_wgs84, "EPSG:22181")
```

Para obtener el perímetro, primero hay que definir un **umbral de clasificación de píxeles quemados vs. píxeles no quemados**. En este caso se utilizó 100 en concordancia con el corte establecido por las categorías propuestas por USGS. 


```{r, message=FALSE, warning=FALSE, include=TRUE, paged.print=FALSE, results = FALSE}
# Definir umbral de corte entre área quemada
umbral <- 100

# Clasificar área quemada vs. no quemada
perimeter <- classify(nbr_wgs84, cbind(-Inf, umbral, NA))   # NA a valores entre -Inf y el umbral
perimeter <- classify(perimeter, cbind(umbral, Inf, 1))     # 1 a valores mayores al umbral - Quemados

# Plot
par(mfrow=c(1,2))    
plot(nbr_wgs84, main = "NBR", col = grey.colors(15), legend = FALSE)
plot(perimeter, main = "Área quemada", legend = FALSE, col = "red")
```

```{r, echo=FALSE, out.width="50%", fig.cap=""}
knitr::include_graphics("https://github.com/romina-gonzalez-musso/Severidad_IncendioLagoMartin/blob/master/_images/2_NBRvsAreaQuemada.png?raw=true")
```

El raster clasificado se poligoniza: 


```{r, message=FALSE, warning=FALSE, include=TRUE, paged.print=FALSE, results = FALSE}
# Poligonizar 
perimeter <- perimeter %>%
  as.polygons(.) %>%    
  st_as_sf(.) %>%       
  st_cast(.,"POLYGON")  # Multipolygon a Simpleparts
```

Se selecciona el polígono de mayor tamaño que será el área del incendio. 

```{r, message=FALSE, warning=FALSE, include=TRUE, paged.print=FALSE, results = FALSE}

perimeter_f1 <- st_transform(perimeter, crs = 22181)

perimeter_f1 <- perimeter_f1 %>%
  mutate(area = st_area(perimeter_f1)) %>% 
  slice_max(area)

perimeter_wgs84 <- st_transform(perimeter_f1, crs = 4326)
```

Y finalmente se grafica para verificar

```{r, message=FALSE, warning=FALSE, include=TRUE, paged.print=FALSE, results = FALSE}

par(mfrow=c(1,1))
plot(nbr_wgs84, col = grey.colors(10), legend = FALSE)
plot(perimeter_wgs84$geometry, col = ("red4"), add = TRUE)
```

```{r, echo=FALSE, out.width="50%", fig.cap=""}
knitr::include_graphics("https://github.com/romina-gonzalez-musso/Severidad_IncendioLagoMartin/blob/master/_images/2_Perimetro_poligono.png?raw=true")
```

Se puede exportar el polígono en formato shape para trabajar en forma local. 

```{r, message=FALSE, warning=FALSE, include=TRUE, paged.print=FALSE, results = FALSE}

st_write(perimeter_wgs84, "poligono_incendio_wgs84.shp", append = FALSE)

```

### **2b.Cálculo de superficie total del incendio**




### **2c.Cálculo de superficies por clases de severidad USGS**

